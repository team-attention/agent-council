#!/usr/bin/env node

const fs = require('fs');
const path = require('path');
const { execSync } = require('child_process');

const GREEN = '\x1b[32m';
const YELLOW = '\x1b[33m';
const CYAN = '\x1b[36m';
const RED = '\x1b[31m';
const NC = '\x1b[0m';

const packageRoot = path.resolve(__dirname, '..');
const targetDir = process.cwd();
const claudeDir = path.join(targetDir, '.claude');
const codexDir = path.join(targetDir, '.codex');

function parseArgs(argv) {
  const args = argv.slice(2);
  const flags = new Set(args);

  const targetIndex = args.indexOf('--target');
  let target = 'auto';
  if (targetIndex !== -1 && args[targetIndex + 1]) {
    target = args[targetIndex + 1];
  } else if (flags.has('--both')) {
    target = 'both';
  } else if (flags.has('--codex')) {
    target = 'codex';
  } else if (flags.has('--claude')) {
    target = 'claude';
  }

  if (!['auto', 'claude', 'codex', 'both'].includes(target)) {
    throw new Error(`Invalid --target "${target}". Use auto|claude|codex|both.`);
  }

  return { target };
}

console.log(`${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}`);
console.log(`${CYAN}  Agent Council - Installation${NC}`);
console.log(`${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}`);
console.log();

function copyRecursive(src, dest) {
  const stat = fs.statSync(src);

  if (stat.isDirectory()) {
    if (!fs.existsSync(dest)) {
      fs.mkdirSync(dest, { recursive: true });
    }
    const files = fs.readdirSync(src);
    for (const file of files) {
      copyRecursive(path.join(src, file), path.join(dest, file));
    }
  } else {
    fs.copyFileSync(src, dest);
    // Preserve executable permission for .sh files
    if (src.endsWith('.sh')) {
      fs.chmodSync(dest, 0o755);
    }
  }
}

function commandExists(command) {
  try {
    const checkCmd = process.platform === 'win32' ? `where ${command}` : `command -v ${command}`;
    execSync(checkCmd, { stdio: 'ignore' });
    return true;
  } catch {
    return false;
  }
}

const KNOWN_MEMBERS = {
  codex: {
    name: 'codex',
    command: 'codex exec',
    emoji: 'ðŸ¤–',
    color: 'BLUE',
    description: 'OpenAI Codex - Code-focused, pragmatic approach',
  },
  gemini: {
    name: 'gemini',
    command: 'gemini',
    emoji: 'ðŸ’Ž',
    color: 'GREEN',
    description: 'Google Gemini - Broad knowledge, diverse perspectives',
  },
};

function buildConfigYaml({ hostRole, detected, enabledMembers }) {
  const detectedList = Object.entries(detected)
    .filter(([, ok]) => ok)
    .map(([name]) => name)
    .sort();
  const detectedText = detectedList.length ? detectedList.join(', ') : 'none';
  const enabledText = enabledMembers.length ? enabledMembers.map((m) => m.name).join(', ') : 'none';

  const header = [
    '# Agent Council Configuration',
    '# Generated by agent-council installer.',
    `# Host target: ${hostRole}`,
    `# Detected CLIs: ${detectedText}`,
    `# Enabled members: ${enabledText}`,
    '#',
    '# Tip: Edit this file to add/remove members as needed.',
    '',
  ].join('\n');

  const memberLines = [];
  for (const member of enabledMembers) {
    memberLines.push(
      `    - name: ${member.name}`,
      `      command: "${member.command}"`,
      `      emoji: "${member.emoji}"`,
      `      color: "${member.color}"`,
      `      description: "${member.description}"`,
      ''
    );
  }

  const membersBlock =
    enabledMembers.length > 0
      ? `  members:\n${memberLines.join('\n')}`.trimEnd()
      : '  members: []';

  const body = [
    'council:',
    membersBlock,
    '',
    '  chairman:',
    '    role: "auto"',
    '    description: "Synthesizes all opinions and provides final recommendation"',
    '',
    '  settings:',
    '    parallel: true',
    '    timeout: 120',
    '    show_thinking: true',
    '    exclude_chairman_from_members: true',
    '',
  ].join('\n');

  return `${header}${body}`;
}

try {
  const { target: requestedTarget } = parseArgs(process.argv);

  const detected = {
    claude: commandExists('claude'),
    codex: commandExists('codex'),
    gemini: commandExists('gemini'),
  };

  const hasClaudeDir = fs.existsSync(claudeDir);
  const hasCodexDir = fs.existsSync(codexDir);

  let target = requestedTarget;
  if (requestedTarget === 'auto') {
    const wantClaude = hasClaudeDir || detected.claude;
    const wantCodex = hasCodexDir || detected.codex;

    if (wantClaude && wantCodex) target = 'both';
    else if (wantCodex) target = 'codex';
    else if (wantClaude) target = 'claude';
    else target = 'claude';

    console.log(`${CYAN}Auto-detected target:${NC} ${target}`);
    if (!wantClaude && !wantCodex) {
      console.log(
        `${YELLOW}  â“˜ Could not detect Claude Code or Codex CLI; defaulting to "claude". Use --target codex if needed.${NC}`
      );
    }
    console.log();
  }

  const installs = [];
  if (target === 'claude' || target === 'both') {
    installs.push({
      label: 'Claude Code',
      rootDir: claudeDir,
      skillsDest: path.join(claudeDir, 'skills', 'agent-council'),
      displayPath: '.claude/skills/agent-council',
      hostRole: 'claude',
    });
  }
  if (target === 'codex' || target === 'both') {
    installs.push({
      label: 'Codex CLI',
      rootDir: codexDir,
      skillsDest: path.join(codexDir, 'skills', 'agent-council'),
      displayPath: '.codex/skills/agent-council',
      hostRole: 'codex',
    });
  }

  // Copy skills folder to target(s)
  const skillsSrc = path.join(packageRoot, 'skills', 'agent-council');

  for (const install of installs) {
    if (!fs.existsSync(install.rootDir)) {
      fs.mkdirSync(install.rootDir, { recursive: true });
    }

    if (fs.existsSync(skillsSrc)) {
      console.log(`${YELLOW}Installing skills (${install.label})...${NC}`);
      copyRecursive(skillsSrc, install.skillsDest);
      console.log(`${GREEN}  âœ“ ${install.displayPath}${NC}`);
    }

    // Copy config file to skill folder if not exists
    const configDest = path.join(install.skillsDest, 'council.config.yaml');
    if (!fs.existsSync(configDest)) {
      console.log(`${YELLOW}Installing config (${install.label})...${NC}`);
      const enabledMembers = [];

      if (detected.codex && install.hostRole !== 'codex') enabledMembers.push(KNOWN_MEMBERS.codex);
      if (detected.gemini && install.hostRole !== 'gemini') enabledMembers.push(KNOWN_MEMBERS.gemini);

      if (enabledMembers.length === 0) {
        console.log(
          `${YELLOW}  â“˜ No member CLIs detected (codex/gemini). Writing an empty members list; edit council.config.yaml to add members.${NC}`
        );
      }

      const yaml = buildConfigYaml({
        hostRole: install.hostRole,
        detected,
        enabledMembers,
      });

      fs.writeFileSync(configDest, yaml, 'utf8');
      console.log(`${GREEN}  âœ“ ${install.displayPath}/council.config.yaml${NC}`);
    } else if (fs.existsSync(configDest)) {
      console.log(`${YELLOW}  â“˜ council.config.yaml already exists (${install.label}), skipping${NC}`);
    }
  }

  console.log();
  console.log(`${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}`);
  console.log(`${GREEN}  Installation complete!${NC}`);
  console.log(`${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}`);
  console.log();
  if (installs.some((i) => i.hostRole === 'claude')) {
    console.log(`${CYAN}Usage in Claude:${NC}`);
    console.log(`  "Summon the council"`);
    console.log(`  "Let's hear opinions from other AIs"`);
    console.log();
  }
  if (installs.some((i) => i.hostRole === 'codex')) {
    console.log(`${CYAN}Usage in Codex:${NC}`);
    console.log(`  "Summon the council"`);
    console.log(`  "Let's hear opinions from other AIs"`);
    console.log();
  }
  console.log();
  console.log(`${CYAN}Direct execution:${NC}`);
  if (installs.some((i) => i.hostRole === 'claude')) {
    console.log(`  .claude/skills/agent-council/scripts/council.sh "your question"`);
  }
  if (installs.some((i) => i.hostRole === 'codex')) {
    console.log(`  .codex/skills/agent-council/scripts/council.sh "your question"`);
  }
  console.log();
  console.log(`${YELLOW}Note: Only detected CLIs are enabled as members in the generated config.${NC}`);
  console.log(`${YELLOW}      Detected: claude=${detected.claude} codex=${detected.codex} gemini=${detected.gemini}${NC}`);

} catch (error) {
  console.error(`${RED}Error during installation: ${error.message}${NC}`);
  process.exit(1);
}
